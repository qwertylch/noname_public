<!DOCTYPE html>
<html
        lang="en"
        class="light-style layout-menu-fixed"
        dir="ltr"
        data-theme="theme-default"
        data-assets-path="../../sneat-1.0.0/assets/"
        data-template="vertical-menu-template-free"
        xmlns:th="http://www.thymeleaf.org"
        xmlns="http://www.w3.org/1999/html">
  <head>
 
    <th:block th:insert="fragments/header :: header"></th:block>
   
      <!-- Fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com" />
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
      <link
              href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
              rel="stylesheet"
      />
      <!-- Icons. Uncomment required icon fonts -->
      <link rel="stylesheet" href="../../sneat-1.0.0/assets/vendor/fonts/boxicons.css" />
      <!-- Core CSS -->
      <link rel="stylesheet" href="../../sneat-1.0.0/assets/vendor/css/core.css" class="template-customizer-core-css" />
      <link rel="stylesheet" href="../../sneat-1.0.0/assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
      <link rel="stylesheet" href="../../sneat-1.0.0/assets/css/demo.css" />
      <!-- Vendors CSS -->
      <link rel="stylesheet" href="../../sneat-1.0.0/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
      <link rel="stylesheet" href="../../css/modal.css"/>
      <!-- 스크립트 사용을 위해 무조건 들어가야된다. -->
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <!-- 벽돌쌓기 정렬 활용위한 추가 -->
      <script src="../../sneat-1.0.0/assets/vendor/libs/masonry/masonry.js"></script>
	<style>
		#dataContainer {
			padding: 100px;
			position: relative;
		}
		
		.gallery-sort {
			display: flex;
    		justify-content: end;
		}
		
		.sort-btn {
			font-weight: 600;
			color: #e0e0e0;
		    margin-left: 1.2rem;
		    text-decoration: none;
		    letter-spacing: 0.04rem;
		    transition: 0.2s;

		}
		
		.sort-btn:hover {
			color: #000;
			border-bottom: solid 2px #000;
		}
		
		.sort-btn.active {
			color: #000;
			border-bottom: solid 2px #000;
		}
		
		.modal-content {
			max-width: 1200px;
			height: 70vh;
		}
		
		.modal-split {
			height: 100%;
		}
		
		.modal-left > img{
			border-radius: 10px 0 0 10px;
		}
		.close,
		#closeModalBtn{
			font-size: 30px;
		    right: 13px;
		    top: 6px;
		}
		
		#replyListDiv{
			height: 80%;
		    border: 1px solid #566a7f;
		    overflow-y: auto;
		    border-radius: 5px;
		
		}
		
		@media (max-width: 1400px) {
            #dataContainer {
				padding: 150px;
			}
		
		
        @media (max-width: 900px) {
            #dataContainer {
				padding: 40px;
			}
		
		    
	</style>
		
  </head>
  <body>
  <div id="dataContainer">
      <div class="gallery-sort">
          <a class="sort-btn active" id="new" href="javascript:void(0);" th:onclick="getProducts('new')">최신 순</a>
          <a class="sort-btn" id="old" href="javascript:void(0);" th:onclick="getProducts('old')">오래된 순</a>
      </div>
      </br>

      <div class="row gy-4" data-masonry='{"percentPosition": true }'>
          <!--리스트에 뿌려질 덩어리 : 이미지, 좋아요, 상세페이지링크..-->
          <div class="col-sm-6 col-lg-4" th:each="products : ${products}">
              <div class="card">
                  <!-- 타임리프에서 데이터 타입으로 전송을 해야 JS에서 받을수 있음...-->
                  <!-- 모달창 열때 이미지, 타이틀, 이미지 고유번호 담아서 JS에 전달 -->
                  <img class="gallery-images"
                       th:data-product-image="${products.productImage}"
                       th:data-product-name="${products.productName}"
                       th:data-product-id="${products.productId}"
                       onclick="showModal(this)"
                       th:src="|/product/image?filename=${products.productImage}|"
                       alt="gallery image"/>
              </div>
          </div>
      </div>
      <!-- 모달창 -->
      <div id="gallery-modal" class="modal">
          <div class="modal-content">
              <span class="close" id="closeModalBtn" onclick="closeModal()">&times;</span>
              <div class="modal-split">

                  <!-- 이미지 창 (모달_왼쪽) -->
                  <div class="modal-left">

                      <img id="modalImage" src="" alt="상세 이미지">
                  </div>


                  <!-- 리뷰 창 (모달_오른쪽) -->
                  <div class="modal-right">
                  	<div class="row  h-100 p-5">
            
                        <h4 id="modalTitle">상세 정보</h4>

                   		<div class="card-body h-70 ps ps--active-y" id="replyListDiv">
                   		
                   		<div class="ps__rail-y"><div class="ps__thumb-y" tabindex="0"></div></div>
                   		</div>
                      <!-- 폼태그 -->
                       <form action="/replies/add" method="post" id="replyForm">
                          <div class="form-group mt-4">
                              <input id="newReplyer" type="hidden" name="replyer" class="form-control"/>
                              <div class="row">
                              	<div class="col-lg-9 p-0">
                              	<input id="newReply" name="reply" class="form-control" placeholder="댓글 내용을 입력해주세요!"/>
                              	</div>
                              	<div class="col-lg-3 p-0  d-flex justify-content-end align-items-center">
                              	<button id="newReplySubmit" type="button" class="btn btn-dark">저장</button>
                              	</div>
                               
                               
                              </div>
                             
                          </div>
                          <!-- productId 값을 pid로 해서 hidden값으로 처리 -> 이벤트 등록, 및 조회 등 JS에서 value값으로 받아서 사용중 -->
                          <input id="pid" name="productId" type="hidden" class="form-control" />
                       </form>
                  	</div>
                  </div>

              </div>
          </div>
      </div>
  </div>




  <script th:inline="javascript">

      // 이미지 클릭 시 모달 열기
      function showModal(element) {
          var productImage = element.getAttribute("data-product-image");
          var productName = element.getAttribute("data-product-name");
          var productId = element.getAttribute("data-product-id");

          var pid = document.getElementById("pid");
          pid.value = productId;

          var modal = document.getElementById("gallery-modal");
          var modalImage = document.getElementById("modalImage");
          var modalTitle = document.getElementById("modalTitle");

          console.log("이미지 경로:", productImage);
          console.log("이미지 요소:", modalImage);

          modalImage.src = "/product/image?filename=" + productImage;
          modalImage.alt = "상세 이미지";
          modalTitle.textContent = productName;

          modal.style.display = "block";
          getReplyList()
      }



      // 댓글 등록 이벤트
      $("#newReplySubmit").on("click", function(e){
        console.log("댓글 저장 버튼 클릭!!!");
        let replyVal = $("#newReply").val();
        let replyerVal = $("#newReplyer").val();
        let pid = $("#pid").val();
        let data = { reply: replyVal, replyer: replyerVal, productId: pid };
        console.log(data);
        $.ajax({
            type: 'post',
            url: '/replies/add',
            data: data,
            success: function(result){
                console.log("add result : " + result);
                $("#newReply").val('');
                $("#newReplyer").val('');
                // 댓글 목록 재 요청
                getReplyList();
            },
            error: function(e){
                console.log("add reply error.....");
                console.log(e);
            }
        });
      });

      // 이미지 눌러서 모달 떴을때 리뷰 목록 불러오기 위함
      // 댓글 목록 조회
      function getReplyList() {
          console.log("reply list!");
          let productId = $("#pid").val();
          console.log("댓글 목록 조회하는데 필요한 productId : " + productId);
          $.ajax({
              type: 'get',
              url: '/replies/list/' + productId,
              success: function(result){
                  console.log("reply list request success");
                  console.log(result);
                  printReplyList(result);
              },
              error: function(e){
                  console.log("reply list request error...");
              }
          });
      }

      // 댓글 목록 화면에 뿌리기
      function printReplyList(result) {
          let html = '';
          result.forEach(function(rep, i){
              html += '<div class="row no-gutters align-items-center"><div class="col mr-2">';
              html += '<div class="h5 mb-0 font-weight-bold text-dark-800">' + rep.reply + '</div>';
              html += '<div class="text-xs font-weight-bold text-gray text-uppercase mb-1" style="margin-left:3px; font-size:5px"> ' + rep.replyer;
              html += ' <span class="ml-2 text-gray-500">' + rep.createDate + '</span></div></div>';
              html += '<div class="col-auto btn-group-sm">';
              html += '<button id="deleteBtn" type="button" data-rid="'+ rep.replyId +'" class="btn btn-outline-dark">삭제</button>';
              html += '</div></div><hr />';
          });
          $("#replyListDiv").html(html);
      }

      // 댓글 삭제 이벤트 등록
      $("#replyListDiv").on("click", "button#deleteBtn", function(e){
          console.log("삭제 버튼 클릭!!!");
          let rid = $(this).data('rid');
          $.ajax({
              type: 'delete',
              url: '/replies/' + rid,
              success: function(result, status) {
                  console.log("삭제 성공!! : " + result);
                  getReplyList(); // 댓글 목록 새로 조회 + 화면에 출력
              },
              error: function(e){
                  console.log("삭제 요청 실패...." + e);
              }
          });
      });



      // 모달 닫기
      function closeModal() {
          var modal = document.getElementById("gallery-modal");
          modal.style.display = "none";
      }
      var newBtn = document.getElementById("new");
      var oldBtn = document.getElementById("old");
      
      // 데이터 불러오는 것은 되는데 masonry형식으로 정렬이 안돼고있음-> 수정 필요
      function getProducts(keyword) {
          // AJAX 요청을 생성하여 선택한 키워드를 Controller로 전달
          jQuery.ajax({
              type: 'GET',
              url: '/gallery', // Controller의 URL
              data: { keyword: keyword }, // 선택한 키워드를 'keyword' 매개변수로 controller에 전달
              success: function(data) { // 키워드 넘겨서 컨트롤러로 부터 받은 결과 값
                  console.log('받은 데이터:', data); // 데이터 확인
                  // 이 부분은 HTML 문자열을 그대로 추가하도록 수정
                  var galleryContainer = document.querySelector('.row[data-masonry]');
                  galleryContainer.innerHTML = data;
                  
                  if(keyword == 'new'){
                	  newBtn.classList.add('active');
                	  oldBtn.classList.remove('active');
                  }else {
                	  oldBtn.classList.add('active');
                	  newBtn.classList.remove('active');
                  }

                  // Masonry 적용
                  var masonry = new Masonry(galleryContainer, {
                      itemSelector: '.col-sm-6',
                      percentPosition: true
                  });
                  masonry.layout();
              }
          });
      }

  </script>
  <!-- 페이지 내 스크립트 부분 -->

  </body>
</html>
